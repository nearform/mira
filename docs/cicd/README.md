# CI/CD

This section describes how Continuous Integration/Continuous Deployment (CI/CD) is implemented in Mira. The CI/CD platform is required to deploy to your chosen environments, which typically are `staging` and `production`.
You define deployment stages by configuring the `cicd.accounts` value.

__Note:__ CI/CD assumes [github actions](https://github.com/features/actions) are used for code mirroring into AWS CodeCommit.
Otherwise developer is responsible for mirroring code into dedicated AWS CodeCommit.

## Deploy Role

CodeBuild runs with an internal role generated by the pipeline. However, Mira needs to assume a specific role with all the permissions for the app.

To do this, create a `DeploymentPermissions` subclass in your app like the following:

```
import { DeploymentPermissions, MiraApp } from '@nearform/mira'
export default class CustomPermissions extends DeploymentPermissions {
  constructor(parent: Construct) {
    super(parent)
    const account = MiraConfig.getEnvironment()
    const baseProject = MiraApp.getBaseStackName()
    this.role.addToPolicy(new PolicyStatement({
      actions: [
        's3:CreateBucket',
        ...
      ],
      resources: [
        `arn:aws:s3:::${baseProject.toLowerCase()}-*`
      ]
    }))

    this.role.addToPolicy(new PolicyStatement({
      actions: [
        'iam:CreateRole',
        ...
      ],
      resources: [
        `arn:aws:iam::${account.env.account}:role/${baseProject}-*`
      ]
    }))
  }
}
```

Then, deploy this in your accounts using the following commands:

```
$ npx mira deploy --file ./path/to/permissions.js --env Staging

$ npx mira deploy --file ./path/to/permissions.js --env Production

```
A role name is auto-generated and the pipeline provides a `ROLE_ARN` environment variable that you can use in your `buildspec.yml` file as follows:

```
build:
    commands:
      - npx mira deploy --file=./infra/src/index.js --env ${ENVIRONMENT} --role "$ROLE_ARN"
  ...
```

## Deploy Pipeline

You can deploy the pipeline with the following command:

```
npx mira cicd
```
For each `cicd.accounts` element in the configuration file, a deploy stage is created.

For each value it's possible to specify a previous manual `Promote` action if `requireManualApproval: true`.

If you need variables or secrets or both available during your deploy phase, you can use `--envVar` as shown in the example below:

### Example 
Deploy the pipeline with a variable and a secret as follows:
```
npx mira cicd --envVar SECRET_TOKEN=123456789 --envVar FOO=bar
```

Then, you can use the secret in `buildspec.yml` file as follows:
```
...
build:
    commands:
      - ./login-to-service.sh --token=${SECRET_TOKEN}
      - npx mira deploy
```



